version: '3.8'

# DEADMAN ULTIMATE SCRAPER - Docker Compose
# ==========================================
# Multi-service orchestration for full deployment.
#
# SECURITY: All services now require authentication.
# Configure credentials in .env file before starting.
#
# Services:
# - elasticsearch: Full-text search and analytics (X-Pack secured)
# - mongodb: User configuration and preferences (authenticated)
# - tor: SOCKS5 proxy for darknet access (control port secured)
# - redis: Caching and pub/sub (password protected)
# - api-server: Express.js REST API
# - dashboard: React frontend (production build served by nginx)
# - scraper: Python scraper worker
#
# Based on zilbers/dark-web-scraper patterns, enhanced for DeadMan.

services:
  # ============================================
  # ELASTICSEARCH - Full-text search engine
  # Security: X-Pack enabled with basic auth
  # ============================================
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: deadman-elasticsearch
    hostname: elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=true
      - xpack.security.enrollment.enabled=false
      - xpack.security.http.ssl.enabled=false
      - xpack.security.transport.ssl.enabled=false
      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD:-changeme}
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
      - network.host=0.0.0.0
    ports:
      - "9200:9200"
      - "9300:9300"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    networks:
      deadman-network:
        ipv4_address: 172.28.0.10
    healthcheck:
      test: ["CMD-SHELL", "curl -s -u elastic:${ELASTIC_PASSWORD:-changeme} http://localhost:9200/_cluster/health | grep -q 'status'"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped

  # ============================================
  # MONGODB - User configuration storage
  # Security: Root credentials required
  # ============================================
  mongodb:
    image: mongo:7.0
    container_name: deadman-mongodb
    hostname: mongodb
    environment:
      - MONGO_INITDB_DATABASE=deadman_scraper
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_ROOT_USER:-deadman}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_ROOT_PASSWORD:-changeme}
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
      - ./docker/mongo-init.js:/docker-entrypoint-initdb.d/init.js:ro
    networks:
      deadman-network:
        ipv4_address: 172.28.0.11
    healthcheck:
      test: ["CMD", "mongosh", "-u", "${MONGO_ROOT_USER:-deadman}", "-p", "${MONGO_ROOT_PASSWORD:-changeme}", "--authenticationDatabase", "admin", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped

  # ============================================
  # TOR PROXY - Darknet access
  # Security: Control port with hashed password
  # ============================================
  tor:
    image: dperson/torproxy
    container_name: deadman-tor
    hostname: tor
    ports:
      - "9050:9050"   # SOCKS5 proxy
      - "8118:8118"   # HTTP proxy (Privoxy)
      - "9051:9051"   # Control port (secured)
    environment:
      - TOR_NewCircuitPeriod=300
      - TOR_MaxCircuitDirtiness=300
      - TOR_ControlPort=9051
      - TOR_HashedControlPassword=${TOR_CONTROL_HASH:-16:872860B76453A77D60CA2BB8C1A7042072093276A3D701AD684053EC4C}
    networks:
      deadman-network:
        ipv4_address: 172.28.0.12
    healthcheck:
      test: ["CMD", "curl", "--socks5", "localhost:9050", "-s", "https://check.torproject.org/api/ip"]
      interval: 60s
      timeout: 30s
      retries: 3
    restart: unless-stopped

  # ============================================
  # REDIS - Caching and pub/sub
  # Security: Password protected
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: deadman-redis
    hostname: redis
    command: redis-server --requirepass ${REDIS_PASSWORD:-changeme} --appendonly yes
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      deadman-network:
        ipv4_address: 172.28.0.13
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-changeme}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ============================================
  # API SERVER - Express.js backend
  # ============================================
  api-server:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: deadman-api
    hostname: api-server
    ports:
      - "8080:8080"
    environment:
      - NODE_ENV=production
      - PORT=8080
      # Elasticsearch with auth
      - ELASTICSEARCH_HOST=http://elasticsearch:9200
      - ELASTIC_USERNAME=elastic
      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD:-changeme}
      # MongoDB with auth
      - MONGODB_URI=mongodb://${MONGO_ROOT_USER:-deadman}:${MONGO_ROOT_PASSWORD:-changeme}@mongodb:27017/deadman_scraper?authSource=admin
      # Redis with auth
      - REDIS_URL=redis://:${REDIS_PASSWORD:-changeme}@redis:6379
      # Tor proxy
      - TOR_PROXY=socks5h://tor:9050
      # Auth0 (optional - set in .env)
      - AUTH0_AUDIENCE=${AUTH0_AUDIENCE:-}
      - AUTH0_ISSUER=${AUTH0_ISSUER:-}
      - AUTH0_DISABLED=${AUTH0_DISABLED:-true}
      # CORS
      - CORS_ORIGIN=${CORS_ORIGIN:-http://localhost:3000}
    volumes:
      - ./server:/app
      - /app/node_modules
    networks:
      deadman-network:
        ipv4_address: 172.28.0.20
    depends_on:
      elasticsearch:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ============================================
  # DASHBOARD - React frontend (nginx)
  # ============================================
  dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
    container_name: deadman-dashboard
    hostname: dashboard
    ports:
      - "3000:80"
    environment:
      - REACT_APP_API_URL=http://localhost:8080
    networks:
      deadman-network:
        ipv4_address: 172.28.0.21
    depends_on:
      - api-server
    restart: unless-stopped

  # ============================================
  # SCRAPER WORKER - Python scraper
  # ============================================
  scraper:
    build:
      context: .
      dockerfile: Dockerfile.scraper
    container_name: deadman-scraper
    hostname: scraper
    environment:
      # Elasticsearch with auth
      - ELASTICSEARCH_HOST=http://elasticsearch:9200
      - ELASTIC_USERNAME=elastic
      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD:-changeme}
      # MongoDB with auth
      - MONGODB_URI=mongodb://${MONGO_ROOT_USER:-deadman}:${MONGO_ROOT_PASSWORD:-changeme}@mongodb:27017/deadman_scraper?authSource=admin
      # API server
      - API_SERVER=http://api-server:8080
      # Tor proxy
      - TOR_PROXY=socks5h://tor:9050
      - TOR_CONTROL_PORT=9051
      - TOR_CONTROL_PASSWORD=${TOR_CONTROL_PASSWORD:-deadman}
      # Python
      - PYTHONUNBUFFERED=1
    volumes:
      - .:/app
      - ./output:/app/output
      - ./logs:/app/logs
    networks:
      deadman-network:
        ipv4_address: 172.28.0.30
    depends_on:
      elasticsearch:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      tor:
        condition: service_healthy
      api-server:
        condition: service_healthy
    restart: unless-stopped

  # ============================================
  # FLARESOLVERR - Cloudflare bypass (optional)
  # ============================================
  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: deadman-flaresolverr
    hostname: flaresolverr
    ports:
      - "8191:8191"
    environment:
      - LOG_LEVEL=info
      - TZ=UTC
    networks:
      deadman-network:
        ipv4_address: 172.28.0.40
    restart: unless-stopped

# ============================================
# NETWORKS
# ============================================
networks:
  deadman-network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.28.0.0/16

# ============================================
# VOLUMES
# ============================================
volumes:
  elasticsearch_data:
    driver: local
  mongodb_data:
    driver: local
  redis_data:
    driver: local
